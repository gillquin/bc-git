parameters:
  - name: SourceRepository
    type: string
    default: ""
  - name: Branch
    type: string
    default: ""

steps:
- checkout: mirror
  persistCredentials: true

- task: powershell@2
  displayName: Sync mirror with upstream
  inputs:
    targetType: 'inline'
    script: |
      function RunAndCheck {
          $loggable = $args -replace '"AUTHORIZATION: [^"]*"','***'
          Write-Host "[command] $loggable"

          $ErrorActionPreference = 'Continue'
          $rest = if ($args.Count -gt 1) { $args[1..($args.Count - 1)] } else { $null }
          & $args[0] $rest
          if ($LASTEXITCODE -ne 0) {
              throw "$loggable failed with exit code $LASTEXITCODE"
          }
      }

      $repo = "${{ parameters.SourceRepository }}"
      $branch = "${{ parameters.Branch }}" -replace "refs/heads/", ""

      Write-Host "Synching $branch from repo $repo"
      
      RunAndCheck git remote add upstream $repo
      RunAndCheck git fetch --all

      RunAndCheck git checkout origin/$branch

      Write-Host "Pulling $Branch from origin"
      RunAndCheck git pull origin $branch

      Write-Host "Pulling $Branch from upstream"
      RunAndCheck git pull upstream $branch

      Write-Host "Pushing $Branch to origin"
      RunAndCheck git push

      Write-Host "Pushing tags"
      RunAndCheck git push origin --tags