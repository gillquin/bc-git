parameters:
  - name: SourceRepository
    type: string
    default: ""
  - name: Branch
    type: string
    default: ""

steps:
- checkout: mirror
  persistCredentials: true

- task: powershell@2
  inputs:
    targetType: 'inline'
    displayName: Sync mirror with upstream
    script: |
      $repo = "${{ parameters.SourceRepository }}"
      $branch = "${{ parameters.Branch }}" -replace "refs/heads/", ""

      Write-Host "Synching $branch from repo $repo"
      
      git remote add upstream $repo
      git fetch --all

      git checkout origin/$branch

      Write-Host "Pulling $Branch from origin"
      git pull origin $branch

      Write-Host "Pulling $Branch from upstream"
      git pull upstream $branch

      Write-Host "Pushing $Branch to origin"
      git push origin $Branch
      git push origin --tags